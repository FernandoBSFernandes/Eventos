#!/usr/bin/env pwsh
<#
.SYNOPSIS
    Script para executar testes com cobertura de c�digo
.DESCRIPTION
    Executa todos os testes do projeto, gera relat�rios e cobertura
.EXAMPLE
    .\testes.ps1
#>

param(
    [switch]$Coverage = $false,
    [switch]$Verbose = $false,
    [switch]$Watch = $false
)

$ErrorActionPreference = "Stop"

Write-Host "
??????????????????????????????????????????????????????????????????
?           ?? Testes Automatizados - Eventos API               ?
??????????????????????????????????????????????????????????????????
" -ForegroundColor Cyan

# Verificar se dotnet est� instalado
try {
    $dotnetVersion = dotnet --version
    Write-Host "? .NET: $dotnetVersion" -ForegroundColor Green
} catch {
    Write-Host "? .NET n�o est� instalado!" -ForegroundColor Red
    exit 1
}

$testCommand = "dotnet test"

if ($Watch) {
    Write-Host "`n?? Modo Watch ativado - testes rodar�o ao salvar arquivos" -ForegroundColor Yellow
    $testCommand = "dotnet watch test"
}

if ($Coverage) {
    Write-Host "`n?? Gerando cobertura de c�digo..." -ForegroundColor Yellow
    $testCommand += ' /p:CollectCoverage=true /p:CoverletOutputFormat=lcov /p:CoverletOutput=./coverage/'
}

if ($Verbose) {
    Write-Host "`n?? Modo verboso ativado" -ForegroundColor Yellow
    $testCommand += " --verbosity detailed"
} else {
    $testCommand += " --verbosity minimal"
}

Write-Host "`n??  Executando: $testCommand`n" -ForegroundColor Cyan

# Executar testes
Invoke-Expression $testCommand
$testResult = $LASTEXITCODE

# An�lise dos resultados
Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

if ($testResult -eq 0) {
    Write-Host "?" + " ? TESTES EXECUTADOS COM SUCESSO!".PadRight(62) + "?" -ForegroundColor Green
} else {
    Write-Host "?" + " ? TESTES FALHARAM!".PadRight(62) + "?" -ForegroundColor Red
}

Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

# Se cobertura foi gerada, exibir informa��es
if ($Coverage -and (Test-Path "./coverage/coverage.info")) {
    Write-Host "`n?? Relat�rio de cobertura gerado em: ./coverage/coverage.info" -ForegroundColor Green
    Write-Host "   Use uma ferramenta como ReportGenerator para visualizar melhor" -ForegroundColor Gray
}

# Retornar c�digo de sa�da
exit $testResult
