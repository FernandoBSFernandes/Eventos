#!/bin/bash

# Script para executar testes com cobertura de código

set -e

COVERAGE=false
VERBOSE=false
WATCH=false

# Processar argumentos
while [[ $# -gt 0 ]]; do
    case $1 in
        -c|--coverage)
            COVERAGE=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -w|--watch)
            WATCH=true
            shift
            ;;
        *)
            echo "Argumento desconhecido: $1"
            exit 1
            ;;
    esac
done

cat << "EOF"

??????????????????????????????????????????????????????????????????
?           ?? Testes Automatizados - Eventos API               ?
??????????????????????????????????????????????????????????????????

EOF

# Verificar se dotnet está instalado
if ! command -v dotnet &> /dev/null; then
    echo "? .NET não está instalado!"
    exit 1
fi

DOTNET_VERSION=$(dotnet --version)
echo "? .NET: $DOTNET_VERSION"

# Construir comando de teste
TEST_COMMAND="dotnet test"

if [ "$WATCH" = true ]; then
    echo "?? Modo Watch ativado - testes rodarão ao salvar arquivos"
    TEST_COMMAND="dotnet watch test"
fi

if [ "$COVERAGE" = true ]; then
    echo "?? Gerando cobertura de código..."
    TEST_COMMAND="$TEST_COMMAND /p:CollectCoverage=true /p:CoverletOutputFormat=lcov /p:CoverletOutput=./coverage/"
fi

if [ "$VERBOSE" = true ]; then
    echo "?? Modo verboso ativado"
    TEST_COMMAND="$TEST_COMMAND --verbosity detailed"
else
    TEST_COMMAND="$TEST_COMMAND --verbosity minimal"
fi

echo
echo "??  Executando: $TEST_COMMAND"
echo

# Executar testes
eval $TEST_COMMAND
TEST_RESULT=$?

# Análise dos resultados
echo
echo "??????????????????????????????????????????????????????????????????"

if [ $TEST_RESULT -eq 0 ]; then
    echo "? ? TESTES EXECUTADOS COM SUCESSO!".ljust(63) "?"
else
    echo "? ? TESTES FALHARAM!".ljust(63) "?"
fi

echo "??????????????????????????????????????????????????????????????????"

# Se cobertura foi gerada, exibir informações
if [ "$COVERAGE" = true ] && [ -f "./coverage/coverage.info" ]; then
    echo
    echo "?? Relatório de cobertura gerado em: ./coverage/coverage.info"
    echo "   Use uma ferramenta como ReportGenerator para visualizar melhor"
fi

exit $TEST_RESULT
